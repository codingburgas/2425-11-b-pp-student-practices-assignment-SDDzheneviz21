{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="text-center mb-4">
                        <i class="fas fa-calculator text-primary me-2"></i>
                        Calculate Calories Burned
                    </h2>
                    <form method="POST" action="{{ url_for('main.predict') }}">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-clock text-primary me-2"></i>
                                {{ form.workout_duration.label }}
                            </label>
                            {{ form.workout_duration(class="form-control", placeholder="Enter duration in minutes") }}
                            {% if form.workout_duration.errors %}
                            <div class="text-danger">
                                {% for error in form.workout_duration.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter your workout duration in minutes (e.g., 30 for 30 minutes)</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-heartbeat text-primary me-2"></i>
                                {{ form.heart_rate.label }}
                            </label>
                            {{ form.heart_rate(class="form-control", placeholder="Enter your average heart rate") }}
                            {% if form.heart_rate.errors %}
                            <div class="text-danger">
                                {% for error in form.heart_rate.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter your average heart rate during the workout (beats per minute)</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-user-alt text-primary me-2"></i>
                                {{ form.age.label }}
                            </label>
                            {{ form.age(class="form-control", placeholder="Enter your age") }}
                            {% if form.age.errors %}
                            <div class="text-danger">
                                {% for error in form.age.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter your age</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-weight text-primary me-2"></i>
                                {{ form.weight.label }}
                            </label>
                            {{ form.weight(class="form-control", placeholder="Enter your weight in kg") }}
                            {% if form.weight.errors %}
                            <div class="text-danger">
                                {% for error in form.weight.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter your weight in kilograms</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-ruler-vertical text-primary me-2"></i>
                                {{ form.height.label }}
                            </label>
                            {{ form.height(class="form-control", placeholder="Enter your height in cm") }}
                            {% if form.height.errors %}
                            <div class="text-danger">
                                {% for error in form.height.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter your height in centimeters</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-thermometer-half text-primary me-2"></i>
                                {{ form.body_temp.label }}
                            </label>
                            {{ form.body_temp(class="form-control", placeholder="Enter your body temperature") }}
                            {% if form.body_temp.errors %}
                            <div class="text-danger">
                                {% for error in form.body_temp.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Enter your body temperature in Celsius (e.g., 37.0)</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-venus-mars text-primary me-2"></i>
                                {{ form.gender.label }}
                            </label>
                            {{ form.gender(class="form-control") }}
                            {% if form.gender.errors %}
                            <div class="text-danger">
                                {% for error in form.gender.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Select your gender</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-eye text-primary me-2"></i>
                                {{ form.is_public.label }}
                            </label>
                            {{ form.is_public(class="form-check-input") }}
                            <small class="form-text text-muted">Make this prediction public</small>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-fire me-2"></i>Calculate Calories
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h3 class="card-title text-center mb-3">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        How to Get Accurate Results
                    </h3>
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-clock text-primary me-2"></i>Workout Duration</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Measure total active time</li>
                                <li><i class="fas fa-check text-success me-2"></i>Include warm-up and cool-down</li>
                                <li><i class="fas fa-check text-success me-2"></i>Convert to minutes</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-heartbeat text-primary me-2"></i>Heart Rate</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Use average heart rate</li>
                                <li><i class="fas fa-check text-success me-2"></i>Measure during peak activity</li>
                                <li><i class="fas fa-check text-success me-2"></i>Use a heart rate monitor</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if prediction_result is not none %}
    <div class="card mt-4">
        <div class="card-body text-center">
            <h4 class="mb-3">Your Predicted Calories Burned:</h4>
            <h2 class="text-success">{{ '%.2f'|format(prediction_result) }} kcal</h2>
            <div class="row mt-4 justify-content-center">
                <div class="col-md-6 mb-4 mb-md-0">
                    <h5>Input Features Diagram</h5>
                    {% if diagram_url %}
                    <img src="{{ diagram_url }}" alt="Input Features Diagram" class="img-fluid" style="max-width:400px;">
                    {% endif %}
                </div>
                {% if probability is not none %}
                <div class="col-md-6">
                    <h5>Probability Output</h5>
                    <div class="mb-2">
                        <span class="fw-bold">Вероятност да изгорите над 200 kcal:</span>
                        <span class="text-primary">{{ (probability*100)|round(1) }}%</span>
                    </div>
                    <div id="probability-bar" style="max-width:400px; margin: 0 auto;"></div>
                    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
                    <script>
                    var proba = {{ probability|tojson }};
                    var data = [{
                        x: ['> 200 kcal', '≤ 200 kcal'],
                        y: [proba*100, (1-proba)*100],
                        type: 'bar',
                        marker: {color: ['#007bff', '#e0e0e0']}
                    }];
                    var layout = {
                        title: 'Probability Distribution',
                        yaxis: {title: 'Probability (%)', range: [0, 100]},
                        xaxis: {title: ''},
                        template: 'plotly_white',
                        margin: { t: 60 }
                    };
                    Plotly.newPlot('probability-bar', data, layout, {displayModeBar: false, responsive: true});
                    </script>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if feature_importance %}
    <div class="card mt-4">
        <div class="card-body">
            <h4 class="text-center mb-3">
                <i class="fas fa-chart-bar text-primary me-2"></i>
                Feature Importance Analysis
            </h4>
            <p class="text-center text-muted mb-4">
                This shows which factors most influence calorie burn predictions in our ML model
            </p>
            <div class="row">
                {% for feature, importance in feature_importance %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h6 class="card-title">{{ feature.replace('_', ' ').title() }}</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-primary" 
                                     role="progressbar" 
                                     style="width: {{ (importance / feature_importance[0][1] * 100)|round(1) }}%"
                                     aria-valuenow="{{ (importance / feature_importance[0][1] * 100)|round(1) }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ (importance / feature_importance[0][1] * 100)|round(1) }}%
                                </div>
                            </div>
                            <small class="text-muted">Importance: {{ importance|round(3) }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 